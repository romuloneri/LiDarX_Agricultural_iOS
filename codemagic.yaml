workflows:
  lidarx_ios:
    name: LiDarX iOS Build
    max_build_duration: 60
    environment:
      xcode: 16.4
      groups:
        - LiDarX   # grupo com APP_STORE_CONNECT_* jÃ¡ criado
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.lidarx.agricultural
      vars:
        XCODE_PROJECT: "LiDarX.xcodeproj"
        XCODE_SCHEME: "LiDarX Agricultural"
        BUNDLE_ID: "com.lidarx.agricultural"
        APPLE_TEAM_ID: "M66N5P2D3F"

    scripts:
      - name: Corrigir Assets.xcassets (forÃ§ar estrutura correta)
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ”§ Ajustando LiDarX/Assets.xcassets..."

          APP_DIR="LiDarX"
          ASSETS_DIR="$APP_DIR/Assets.xcassets"

          # Garante que LiDarX Ã© diretÃ³rio
          if [ -e "$APP_DIR" ] && [ ! -d "$APP_DIR" ]; then
            echo "âš ï¸ '$APP_DIR' Ã© um arquivo, movendo para backup..."
            mv "$APP_DIR" "${APP_DIR}.file_backup_$(date +%s)"
          fi
          mkdir -p "$APP_DIR"

          # Garante que Assets.xcassets Ã© diretÃ³rio com Contents.json
          if [ -e "$ASSETS_DIR" ] && [ ! -d "$ASSETS_DIR" ]; then
            echo "âš ï¸ '$ASSETS_DIR' nÃ£o Ã© diretÃ³rio, movendo para backup..."
            mv "$ASSETS_DIR" "${ASSETS_DIR}.bak_$(date +%s)"
          fi
          mkdir -p "$ASSETS_DIR"

          cat > "$ASSETS_DIR/Contents.json" << 'EOF'
          {
            "info": {
              "version": 1,
              "author": "xcode"
            }
          }
          EOF

          echo "âœ… Assets.xcassets OK em: $ASSETS_DIR"

      - name: Criar LaunchScreen.storyboard se nÃ£o existir
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ§¾ Verificando LaunchScreen.storyboard..."

          APP_DIR="LiDarX"
          LS_FILE="$APP_DIR/LaunchScreen.storyboard"

          mkdir -p "$APP_DIR"

          if [ -f "$LS_FILE" ]; then
            echo "âœ… LaunchScreen.storyboard jÃ¡ existe em: $LS_FILE"
          else
            echo "âš ï¸ LaunchScreen.storyboard nÃ£o existe. Criando dummy..."
            cat > "$LS_FILE" << 'EOF'
            <?xml version="1.0" encoding="UTF-8"?>
            <document type="com.apple.InterfaceBuilder3.CocoaTouch.Storyboard.XIB" version="3.0" toolsVersion="20037" targetRuntime="iOS.CocoaTouch" propertyAccessControl="none" useAutolayout="YES" useTraitCollections="YES" colorMatched="YES" initialViewController="VC">
              <device id="retina6_1" orientation="portrait" appearance="light"/>
              <scenes>
                <!-- Launch Screen -->
                <scene sceneID="scene">
                  <objects>
                    <viewController id="VC" sceneMemberID="viewController">
                      <view key="view" contentMode="scaleToFill" id="view">
                        <rect key="frame" x="0.0" y="0.0" width="414" height="896"/>
                        <color key="backgroundColor" systemColor="systemBackgroundColor"/>
                      </view>
                    </viewController>
                    <placeholder placeholderIdentifier="IBFirstResponder" id="responder" userLabel="First Responder" sceneMemberID="firstResponder"/>
                  </objects>
                </scene>
              </scenes>
            </document>
            EOF
            echo "âœ… LaunchScreen.storyboard criado em: $LS_FILE"
          fi

      - name: Clean
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ§¹ Limpando projeto..."
          xcodebuild -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME" clean || true

      - name: Remover Info.plist do Copy Bundle Resources
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ”§ Removendo 'Info.plist in Resources' do projeto para evitar duplicidade..."

          PBXPROJ="$XCODE_PROJECT/project.pbxproj"

          if [ ! -f "$PBXPROJ" ]; then
            echo "âŒ Arquivo $PBXPROJ nÃ£o encontrado."
            exit 1
          fi

          if grep -q "Info.plist in Resources" "$PBXPROJ"; then
            echo "âš ï¸ Entrada 'Info.plist in Resources' encontrada. Limpando..."
            sed -i '' "/Info.plist in Resources/d" "$PBXPROJ"
            echo "âœ… Todas as referÃªncias a 'Info.plist in Resources' foram removidas."
          else
            echo "â„¹ï¸ Nenhuma entrada 'Info.plist in Resources' encontrada. Nada a fazer."
          fi

      - name: Archive (assinar usando certificado/perfil especÃ­ficos)
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ“¦ Gerando archive com assinatura manual..."
          ARCH_PATH="$CM_BUILD_DIR/LiDarX.xcarchive"

          xcodebuild -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            PROVISIONING_PROFILE_SPECIFIER="LiDarX_Distribution_Profile" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE="Manual" \
            archive -archivePath "$ARCH_PATH"

          echo "âœ… Archive gerado em: $ARCH_PATH"

      - name: Gerar ExportOptions.plist
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ“ Gerando ExportOptions.plist..."
          cat > "$CM_BUILD_DIR/ExportOptions.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict>
          </plist>
          EOF
          echo "âœ… ExportOptions.plist OK"

      - name: Export .ipa
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ðŸ“¤ Exportando IPA..."
          ARCH_PATH="$CM_BUILD_DIR/LiDarX.xcarchive"
          xcodebuild -exportArchive \
            -archivePath "$ARCH_PATH" \
            -exportOptionsPlist "$CM_BUILD_DIR/ExportOptions.plist" \
            -exportPath "$CM_EXPORT_DIR"
          echo "âœ… IPA exportado:"
          ls -lah "$CM_EXPORT_DIR"

    artifacts:
      - $CM_EXPORT_DIR/*.ipa
      - $CM_BUILD_DIR/LiDarX.xcarchive

    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
